import { Widget as WidgetConfig, TableListConfig, ZeroStateReason } from '@al/ng-visualizations-components';

/**
 * mostSeenCVEsBI transformation
 * kalm: dashboards_top_cve_vulnerabilities
 * @param response - raw data from API
 */
export const mostSeenCVEsBI = (response: { rows: any[][], column_info: { type: string, name: string } }) => {
  enum Column {
    VulnerabilityId,
    CveId,
    CveName,
    Severity,
    VulnerabilityCount,
    VulnerabilityTotal
  }
  const assets = response.rows;

  if (assets.length === 0) {
    return {
      nodata: true,
      reason: ZeroStateReason.Zero
    };
  }

  const tableConfig: TableListConfig = {
    headers: [
      { name: 'CVE ID', field: 'id', class: 'left nowrap' },
      { name: 'Name', field: 'summary', class: 'left' },
      { name: 'Severity', field: 'status', class: 'left status' },
      { name: 'Count', field: 'count', class: 'right' },
      { name: '% of Open', field: 'percent', class: 'right' }
    ],
    body: []
  };

  tableConfig.body = assets.map(asset => ({
    id: asset[Column.CveId],
    summary: asset[Column.CveName],
    count: asset[Column.VulnerabilityCount],
    status: String(asset[Column.Severity]).toLowerCase(),
    recordLink: {
      vulnerabilityId: asset[Column.VulnerabilityId]
    },
    percent: `${Math.round((asset[Column.VulnerabilityCount] / asset[Column.VulnerabilityTotal]) * 100)}%`
  }));

  return tableConfig;
};
