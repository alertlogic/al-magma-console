import { mostVulnerableDeployments } from '../most_vulnerable_deployments.transformation';
import { ExposuresSummary} from '@al/assets-query';

describe('Transformation Test Suite: Most Vulnerable Deployments', () => {
  describe('Given an Assets Scanned response object', () => {
    it('should extract the agent health scores for use in a correctly formatted chart config', () => {
      const deployments = [{
        id: '12345',
        name:  'Deployment A'
      },{
        id: '67890',
        name:  'Deployment B'
      }];
      const response: ExposuresSummary = {
        exposures: [{
          name: 'Deployment A',
          type: 'foo',
          tri: 1,
          threatiness: 1,
          summary: {
            high: 5,
            medium: 3,
            low: 7,
            info: 11
          },
          severity: 1,
          raw_severity: 1,
          p90_severity: 1,
          key: 'bla',
          deployment_id: '12345',
          asset_count: 1,
          account_id: 'string'
        },{
          name: 'Deployment B',
          type: 'foo',
          tri: 1,
          threatiness: 1,
          summary: {
            high: 8,
            medium: 4,
            low: 1,
            info: 9
          },
          severity: 1,
          raw_severity: 1,
          p90_severity: 1,
          key: 'bla',
          deployment_id: '67890',
          asset_count: 1,
          account_id: 'string'
        }],
        summary: {
          all: 20,
          high: 5,
          medium: 3,
          low: 7,
          info: 11
        },
      };
      expect(mostVulnerableDeployments([response, deployments])).toEqual({
        description: 'Count of Vulnerabilities',
        dateOptions: ['Deployment A', 'Deployment B'],
        series: [
          {
              name:'Info',
              data: [
                {x: 0, y: 11, recordLink: {severity: 'info', deployment_id: '12345'}},
                {x: 1, y: 9, recordLink: {severity: 'info', deployment_id: '67890'}}
              ],
              className: 'info',
              legendIndex: 3
          }, {
              name:'Low',
              data: [
                {x: 0, y: 7, recordLink: {severity: 'low', deployment_id: '12345'}},
                {x: 1, y: 1, recordLink: {severity: 'low', deployment_id: '67890'}}
              ],
              className: 'low',
              legendIndex: 2
          }, {
              name:'Medium',
              data: [
                {x: 0, y: 3, recordLink: {severity: 'medium', deployment_id: '12345'}},
                {x: 1, y: 4, recordLink: {severity: 'medium', deployment_id: '67890'}}
              ],
              className: 'medium',
              legendIndex: 1
          },{
            name:'High',
            data: [
              {x: 0, y: 5, recordLink: {severity: 'high', deployment_id: '12345'}},
              {x: 1, y: 8, recordLink: {severity: 'high', deployment_id: '67890'}}
            ],
            className: 'critical',
            legendIndex: 0
          }
        ]
      });
    });
  });
});
